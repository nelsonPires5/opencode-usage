name: Publish Package

on:
  push:
    tags:
      - 'v*' # Triggers on v1.0.0, v0.0.2-dev, etc.

permissions:
  id-token: write
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@d6e32c1796099e0f1f3ac741c220a8b7eae9e5dd
        with:
          install: true
          cache: true
          experimental: true

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: mise run build

      - name: Publish to npm with OIDC
        run: |
          # Use 'next' for prerelease versions (-dev, -alpha, -beta, -rc), otherwise 'latest'
          VERSION="${{ github.ref_name }}"
          if [[ "$VERSION" =~ -dev|-alpha|-beta|-rc ]]; then
            TAG="next"
          else
            TAG="latest"
          fi

          echo "Publishing version $VERSION with tag: $TAG"
          mise run publish --tag "$TAG"
